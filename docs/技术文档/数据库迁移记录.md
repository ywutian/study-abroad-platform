# 数据库迁移记录

## 迁移概览

| 迁移名称                                  | 日期       | 状态       | 说明                                                         |
| ----------------------------------------- | ---------- | ---------- | ------------------------------------------------------------ |
| `0_enable_pgvector`                       | —          | ✅ Applied | 启用 pgvector 扩展                                           |
| `1_create_vector_indexes`                 | —          | ✅ Applied | 创建 Memory/Entity 向量 HNSW 索引                            |
| `20260126_add_vector_indexes`             | 2026-01-26 | ✅ Applied | 向量索引 + 复合索引优化                                      |
| `20260126_agent_enterprise`               | 2026-01-26 | ✅ Applied | 企业级 Agent 系统表（Token、Quota、Audit、Security、Config） |
| `20260203_memory_index_optimization`      | 2026-02-03 | ✅ Applied | Memory 表索引优化 + 审计/安全/任务索引                       |
| `20260207_add_competition_model`          | 2026-02-07 | ✅ Applied | Competition 模型 + Award.competitionId 外键                  |
| `20260209_review_mode_overhaul`           | 2026-02-09 | ✅ Applied | Review 模型重构 + ReviewReaction + ReviewStatus 枚举         |
| `20260211_add_essay_scraper_tables`       | 2026-02-11 | ✅ Applied | SchoolEssaySource + EssayPipelineRun 表                      |
| `20260211_add_payment_model`              | 2026-02-11 | ✅ Applied | Payment 模型 + PaymentStatus 枚举                            |
| `20260212_add_message_recall`             | 2026-02-12 | ✅ Applied | Message 表新增 isRecalled/recalledAt 字段                    |
| `20260212_fix_duplicate_forum_categories` | 2026-02-12 | ✅ Applied | 去重 ForumCategory + 唯一约束                                |

---

## 0_enable_pgvector

启用 PostgreSQL 的 pgvector 扩展。如果数据库不支持（如 Railway 默认 PostgreSQL），则跳过。

```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

---

## 1_create_vector_indexes

为 Memory 和 Entity 表的 `embedding` 列创建 HNSW 向量索引（条件创建：仅在表和 pgvector 扩展存在时）。

---

## 20260126_add_vector_indexes

向量索引 + 复合索引优化，包括：

- Memory/Entity 表 HNSW 索引 (`vector_cosine_ops`, m=16, ef_construction=64)
- Memory 复合索引：`userId+type`、`userId+importance`、`expiresAt`
- Entity 复合索引：`userId+type`
- AgentMessage 索引：`conversationId+createdAt`
- AgentConversation 索引：`userId+updatedAt`

---

## 20260126_agent_enterprise

企业级 Agent 系统数据库扩展，新增 7 张表：

1. **AgentTokenUsage** — Token 使用记录
2. **AgentQuota** — 用户配额（FREE/PRO/ENTERPRISE）
3. **AgentAuditLog** — 审计日志
4. **AgentSecurityEvent** — 安全事件（PROMPT_INJECTION/PII_DETECTED 等）
5. **AgentConfigVersion** — 配置版本管理（支持热更新和回滚）
6. **MemoryCompaction** — 记忆压缩记录
7. **AgentTask** — 异步任务调度

---

## 20260203_memory_index_optimization

Memory 表索引优化，新增：

- `userId+type+importance` 复合索引
- `userId+category` 索引
- `accessCount+lastAccessedAt` 索引（用于衰减任务）
- `updatedAt` 索引（用于增量同步）
- AgentAuditLog、AgentSecurityEvent、AgentTokenUsage、AgentTask 的额外索引

---

## 20260207_add_competition_model

### 背景

在 2026-02-06 的学校统计与评分系统升级中，引入了 `Competition` 模型来标准化竞赛数据库。该模型最初通过 `prisma db push` 直接同步到数据库，但缺少正式的迁移文件。

### 问题

1. **Shadow Database 失败**：尝试 `prisma migrate dev` 时，shadow database 无法重放旧迁移（旧迁移引用了当时不存在的表），导致 P3006 错误。
2. **Schema 漂移**：数据库已同步但迁移历史缺少对应记录，`prisma migrate status` 显示 drift。
3. **缺少 `migration_lock.toml`**：迁移目录中缺少锁文件。

### 解决方案

采用手动创建迁移 + `prisma migrate resolve` 的方式：

1. 创建 `apps/api/prisma/migrations/migration_lock.toml`
2. 通过 `prisma migrate diff --from-url ... --to-schema-datamodel ...` 确认数据库已与 `schema.prisma` 同步（diff 为空）
3. 手动创建 `20260207_add_competition_model/migration.sql`
4. 执行 `npx prisma migrate resolve --applied 20260207_add_competition_model` 标记为已应用

### 迁移内容

```sql
-- CreateEnum
CREATE TYPE "CompetitionCategory" AS ENUM (
  'MATH', 'BIOLOGY', 'PHYSICS', 'CHEMISTRY',
  'COMPUTER_SCIENCE', 'ENGINEERING_RESEARCH',
  'ECONOMICS_BUSINESS', 'DEBATE_SPEECH',
  'WRITING_ESSAY', 'GENERAL_ACADEMIC',
  'ARTS_MUSIC', 'OTHER'
);

-- CreateTable
CREATE TABLE "Competition" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "abbreviation" TEXT NOT NULL,
    "nameZh" TEXT,
    "category" "CompetitionCategory" NOT NULL,
    "level" "AwardLevel" NOT NULL,
    "tier" INTEGER NOT NULL,
    "description" TEXT,
    "descriptionZh" TEXT,
    "website" TEXT,
    "isActive" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "Competition_pkey" PRIMARY KEY ("id")
);

-- Indexes
CREATE UNIQUE INDEX "Competition_abbreviation_key" ON "Competition"("abbreviation");
CREATE INDEX "Competition_category_idx" ON "Competition"("category");
CREATE INDEX "Competition_tier_idx" ON "Competition"("tier");

-- AlterTable: Add competitionId to Award
ALTER TABLE "Award" ADD COLUMN "competitionId" TEXT;
CREATE INDEX "Award_competitionId_idx" ON "Award"("competitionId");
ALTER TABLE "Award" ADD CONSTRAINT "Award_competitionId_fkey"
  FOREIGN KEY ("competitionId") REFERENCES "Competition"("id")
  ON DELETE SET NULL ON UPDATE CASCADE;
```

### 模型关系

```
Competition (1) <-- (N) Award
  - id (PK)              - competitionId (FK, nullable)
  - name                  - ...
  - abbreviation (unique)
  - category (CompetitionCategory)
  - level (AwardLevel)
  - tier (1-5)
```

### 注意事项

- 迁移历史中存在旧迁移无法在 shadow database 中重放的问题。如果将来需要执行 `prisma migrate dev`（例如添加新迁移），可能需要使用 `--create-only` 标志然后手动标记。
- 推荐在生产部署时使用 `prisma migrate deploy` 而非 `prisma migrate dev`。
- `Award.competitionId` 为可选字段（`SET NULL`），旧奖项无需关联竞赛。

---

## 20260209_review_mode_overhaul

锐评模式重构：

- 重命名 `Review.essayScore` 为 `testScore`（语义修正：标化成绩而非文书）
- 新增 `awardScore` 评分维度
- 新增按模块评语字段：`academicComment`、`testComment`、`activityComment`、`awardComment`
- 新增 `ReviewStatus` 枚举 (`DRAFT`/`PUBLISHED`/`HIDDEN`)
- 新增 `tags`、`helpfulCount` 元数据字段
- 新增 `ReviewReaction` 模型（支持点赞/踩等互动）

---

## 20260211_add_essay_scraper_tables

Essay Scraper 模块扩展：

- `EssayPrompt` 新增 `changeType`、`previousYearPromptId` 字段
- `EssayPromptSource` 新增 `confidence`、`rawContent` 字段
- 新增 `SchoolEssaySource` 表（学校文书数据源管理）
- 新增 `EssayPipelineRun` 表（爬取流水线运行记录）

---

## 20260211_add_payment_model

支付系统：

- 新增 `PaymentStatus` 枚举 (`PENDING`/`SUCCESS`/`FAILED`/`REFUNDED`)
- 新增 `Payment` 表，包含 `transactionId`（唯一）、`idempotencyKey`（唯一）、金额、状态等
- 外键关联 `User`，支持级联删除

---

## 20260212_add_message_recall

消息撤回功能：

- `Message` 表新增 `isRecalled` (BOOLEAN, 默认 false) 和 `recalledAt` (TIMESTAMP) 字段

---

## 20260212_fix_duplicate_forum_categories

修复重复论坛分类：

- 将重复分类下的帖子合并到保留帖子最多的分类
- 删除重复分类记录
- 新增唯一约束：`ForumCategory.name`、`ForumCategory.nameZh`

---

## 最佳实践

### 创建迁移

```bash
# 推荐：仅生成 SQL 不自动执行
npx prisma migrate dev --name <migration_name> --create-only

# 检查生成的 SQL 后手动执行
npx prisma migrate deploy
```

### 数据库同步（开发环境）

```bash
# 快速同步（不创建迁移文件，仅限开发）
npx prisma db push

# 查看 schema 与数据库差异
npx prisma migrate diff --from-url $DATABASE_URL --to-schema-datamodel ./prisma/schema.prisma --script
```

### 迁移状态检查

```bash
npx prisma migrate status
```
