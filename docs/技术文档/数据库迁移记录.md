# 数据库迁移记录

## 迁移概览

| 迁移名称                         | 日期       | 状态       | 说明                                        |
| -------------------------------- | ---------- | ---------- | ------------------------------------------- |
| `20260207_add_competition_model` | 2026-02-07 | ✅ Applied | Competition 模型 + Award.competitionId 外键 |

---

## 20260207_add_competition_model

### 背景

在 2026-02-06 的学校统计与评分系统升级中，引入了 `Competition` 模型来标准化竞赛数据库。该模型最初通过 `prisma db push` 直接同步到数据库，但缺少正式的迁移文件。

### 问题

1. **Shadow Database 失败**：尝试 `prisma migrate dev` 时，shadow database 无法重放旧迁移（旧迁移引用了当时不存在的表），导致 P3006 错误。
2. **Schema 漂移**：数据库已同步但迁移历史缺少对应记录，`prisma migrate status` 显示 drift。
3. **缺少 `migration_lock.toml`**：迁移目录中缺少锁文件。

### 解决方案

采用手动创建迁移 + `prisma migrate resolve` 的方式：

1. 创建 `apps/api/prisma/migrations/migration_lock.toml`
2. 通过 `prisma migrate diff --from-url ... --to-schema-datamodel ...` 确认数据库已与 `schema.prisma` 同步（diff 为空）
3. 手动创建 `20260207_add_competition_model/migration.sql`
4. 执行 `npx prisma migrate resolve --applied 20260207_add_competition_model` 标记为已应用

### 迁移内容

```sql
-- CreateEnum
CREATE TYPE "CompetitionCategory" AS ENUM (
  'MATH', 'BIOLOGY', 'PHYSICS', 'CHEMISTRY',
  'COMPUTER_SCIENCE', 'ENGINEERING_RESEARCH',
  'ECONOMICS_BUSINESS', 'DEBATE_SPEECH',
  'WRITING_ESSAY', 'GENERAL_ACADEMIC',
  'ARTS_MUSIC', 'OTHER'
);

-- CreateTable
CREATE TABLE "Competition" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "abbreviation" TEXT NOT NULL,
    "nameZh" TEXT,
    "category" "CompetitionCategory" NOT NULL,
    "level" "AwardLevel" NOT NULL,
    "tier" INTEGER NOT NULL,
    "description" TEXT,
    "descriptionZh" TEXT,
    "website" TEXT,
    "isActive" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "Competition_pkey" PRIMARY KEY ("id")
);

-- Indexes
CREATE UNIQUE INDEX "Competition_abbreviation_key" ON "Competition"("abbreviation");
CREATE INDEX "Competition_category_idx" ON "Competition"("category");
CREATE INDEX "Competition_tier_idx" ON "Competition"("tier");

-- AlterTable: Add competitionId to Award
ALTER TABLE "Award" ADD COLUMN "competitionId" TEXT;
CREATE INDEX "Award_competitionId_idx" ON "Award"("competitionId");
ALTER TABLE "Award" ADD CONSTRAINT "Award_competitionId_fkey"
  FOREIGN KEY ("competitionId") REFERENCES "Competition"("id")
  ON DELETE SET NULL ON UPDATE CASCADE;
```

### 模型关系

```
Competition (1) <-- (N) Award
  - id (PK)              - competitionId (FK, nullable)
  - name                  - ...
  - abbreviation (unique)
  - category (CompetitionCategory)
  - level (AwardLevel)
  - tier (1-5)
```

### 注意事项

- 迁移历史中存在旧迁移无法在 shadow database 中重放的问题。如果将来需要执行 `prisma migrate dev`（例如添加新迁移），可能需要使用 `--create-only` 标志然后手动标记。
- 推荐在生产部署时使用 `prisma migrate deploy` 而非 `prisma migrate dev`。
- `Award.competitionId` 为可选字段（`SET NULL`），旧奖项无需关联竞赛。

---

## 最佳实践

### 创建迁移

```bash
# 推荐：仅生成 SQL 不自动执行
npx prisma migrate dev --name <migration_name> --create-only

# 检查生成的 SQL 后手动执行
npx prisma migrate deploy
```

### 数据库同步（开发环境）

```bash
# 快速同步（不创建迁移文件，仅限开发）
npx prisma db push

# 查看 schema 与数据库差异
npx prisma migrate diff --from-url $DATABASE_URL --to-schema-datamodel ./prisma/schema.prisma --script
```

### 迁移状态检查

```bash
npx prisma migrate status
```
