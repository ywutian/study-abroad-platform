name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop, 'feature/**', 'fix/**', 'release/**']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint API
        run: pnpm --filter api lint

      - name: Lint Web
        run: pnpm --filter web lint

      - name: Check i18n (hardcoded text & key consistency)
        run: pnpm --filter web lint:i18n

      - name: Check commit messages
        if: github.event_name == 'pull_request'
        run: |
          pnpm exec commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }}

      - name: Dependency audit
        run: pnpm audit --audit-level=high --registry=https://registry.npmjs.org
        continue-on-error: true

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter api exec prisma generate

      - name: Type check API
        run: pnpm --filter api exec tsc --noEmit --project tsconfig.build.json

      - name: Type check Web
        run: pnpm --filter web exec tsc --noEmit

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter api exec prisma generate

      - name: Run API tests
        run: pnpm --filter api exec jest --coverage --passWithNoTests --forceExit

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/api/coverage/lcov.info
          flags: api
          fail_ci_if_error: false

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: studyabroad_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter api exec prisma generate

      - name: Enable pgvector extension
        run: PGPASSWORD=postgres psql -h localhost -U postgres -d studyabroad_test -c "CREATE EXTENSION IF NOT EXISTS vector;"

      - name: Push schema to database
        run: pnpm --filter api exec prisma db push --skip-generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/studyabroad_test?schema=public

      - name: Seed database
        run: pnpm --filter api exec prisma db seed
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/studyabroad_test?schema=public

      - name: Run E2E tests
        run: pnpm --filter api exec jest --config ./test/jest-e2e.json --forceExit
        timeout-minutes: 5
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/studyabroad_test?schema=public
          JWT_SECRET: test-secret-key-for-ci-e2e-testing
          JWT_REFRESH_SECRET: test-refresh-secret-key-for-ci
          JWT_EXPIRES_IN: 15m
          JWT_REFRESH_EXPIRES_IN: 7d

  doc-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check API docs sync
        run: |
          CHANGED_CONTROLLERS=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD -- 'apps/api/src/modules/**/*.controller.ts' | wc -l | tr -d ' ')
          if [ "$CHANGED_CONTROLLERS" -gt "0" ]; then
            API_DOC_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD -- 'docs/API_REFERENCE.md' | wc -l | tr -d ' ')
            if [ "$API_DOC_CHANGED" -eq "0" ]; then
              echo "::warning::Controller files were modified but docs/API_REFERENCE.md was not updated. Please verify the API reference is still accurate."
            fi
          fi

      - name: Check schema docs sync
        run: |
          SCHEMA_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD -- 'apps/api/prisma/schema.prisma' | wc -l | tr -d ' ')
          if [ "$SCHEMA_CHANGED" -gt "0" ]; then
            ARCH_DOC_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD -- 'docs/ARCHITECTURE.md' | wc -l | tr -d ' ')
            if [ "$ARCH_DOC_CHANGED" -eq "0" ]; then
              echo "::warning::Schema was modified but docs/ARCHITECTURE.md was not updated. Please verify the architecture doc is still accurate."
            fi
          fi

      - name: Verify doc links
        run: |
          BROKEN=0
          for file in docs/*.md; do
            while IFS= read -r line; do
              link=$(echo "$line" | grep -oP '\]\(\K[^)]+' | head -1)
              if [ -n "$link" ] && [[ ! "$link" =~ ^http ]] && [[ ! "$link" =~ ^# ]] && [[ ! "$link" =~ ^mailto ]]; then
                dir=$(dirname "$file")
                resolved="$dir/$link"
                if [ ! -e "$resolved" ]; then
                  echo "::warning file=$file::Broken link: $link"
                  BROKEN=$((BROKEN + 1))
                fi
              fi
            done < <(grep -n '\](' "$file" || true)
          done
          if [ "$BROKEN" -gt "0" ]; then
            echo "::warning::Found $BROKEN potentially broken documentation links"
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter api exec prisma generate

      - name: Build API
        run: pnpm --filter api build

      - name: Build Web
        run: pnpm --filter web build
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.API_URL || 'http://localhost:3002' }}

      - name: Upload API build
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: apps/api/dist
          retention-days: 7

      - name: Upload Web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/.next
          retention-days: 7

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  sbom:
    name: SBOM Generation
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate SBOM (CycloneDX)
        run: |
          mkdir -p sbom
          npx @cyclonedx/cdxgen -o sbom/bom.json --deep -t js --spec-version 1.5

      - name: Verify SBOM
        run: pnpm sbom:verify

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom/bom.json
          retention-days: 90

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true
          trivyignores: '.trivyignore'
          skip-dirs: 'node_modules,.next,dist,coverage'
