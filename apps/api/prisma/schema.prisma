generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

enum Role {
  USER
  VERIFIED
  ADMIN
}

enum Visibility {
  PRIVATE
  PUBLIC
  ANONYMOUS
  VERIFIED_ONLY
}

enum BudgetTier {
  LOW
  MEDIUM
  HIGH
  UNLIMITED
}

enum TestType {
  SAT
  ACT
  TOEFL
  IELTS
  AP
  IB
}

enum ActivityCategory {
  ACADEMIC
  ARTS
  ATHLETICS
  COMMUNITY_SERVICE
  LEADERSHIP
  WORK
  RESEARCH
  OTHER
}

enum AwardLevel {
  SCHOOL
  REGIONAL
  STATE
  NATIONAL
  INTERNATIONAL
}

enum CompetitionCategory {
  MATH
  BIOLOGY
  PHYSICS
  CHEMISTRY
  COMPUTER_SCIENCE
  ENGINEERING_RESEARCH
  ECONOMICS_BUSINESS
  DEBATE_SPEECH
  WRITING_ESSAY
  GENERAL_ACADEMIC
  ARTS_MUSIC
  OTHER
}

enum ReportTargetType {
  USER
  MESSAGE
  CASE
  REVIEW
  POST // 帖子举报
  COMMENT // 评论举报
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AdmissionResult {
  ADMITTED
  REJECTED
  WAITLISTED
  DEFERRED
}

enum TaskType {
  ESSAY
  DOCUMENT
  TEST
  INTERVIEW
  RECOMMENDATION
  OTHER
}

enum ApplicationStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  ACCEPTED
  REJECTED
  WAITLISTED
  WITHDRAWN
}

enum GlobalEventCategory {
  TEST // 标化考试（SAT, ACT, TOEFL, IELTS）
  COMPETITION // 竞赛（AMC, USABO, Intel ISEF 等）
  SUMMER_PROGRAM // 夏校/暑期项目
  FINANCIAL_AID // 助学金（FAFSA, CSS Profile）
  APPLICATION // 申请平台（Common App 开放日等）
  OTHER
}

enum PersonalEventCategory {
  COMPETITION // 竞赛（AMC, USABO, ISEF...）
  TEST // 标化考试（SAT, ACT, TOEFL...）
  SUMMER_PROGRAM // 夏校/暑期项目
  INTERNSHIP // 实习
  ACTIVITY // 课外活动（社团、志愿者...）
  MATERIAL // 材料准备（推荐信、成绩单、作品集）
  OTHER
}

enum PersonalEventStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VaultItemType {
  PASSWORD
  CREDENTIAL
  DOCUMENT
  NOTE
  API_KEY
  OTHER
}

// ============================================
// User & Auth
// ============================================

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  passwordHash         String
  role                 Role      @default(USER)
  emailVerified        Boolean   @default(false)
  emailVerifyToken     String?
  passwordResetToken   String?
  passwordResetExpires DateTime?
  locale               String    @default("zh")

  // Relations
  profile         Profile?
  followers       Follow[]                  @relation("Following")
  following       Follow[]                  @relation("Followers")
  blockedUsers    Block[]                   @relation("Blocker")
  blockedBy       Block[]                   @relation("Blocked")
  sentMessages    Message[]
  conversations   ConversationParticipant[]
  customRankings  CustomRanking[]
  reviewsGiven      Review[]                  @relation("Reviewer")
  reviewsReceived   Review[]                  @relation("ReviewedProfile")
  reviewReactions   ReviewReaction[]
  reports           Report[]
  admissionCases  AdmissionCase[]
  userLists       UserList[]
  userListVotes   UserListVote[]
  schoolListItems SchoolListItem[]

  // Forum relations
  forumPosts      ForumPost[]
  forumComments   ForumComment[]
  teamMemberships TeamMember[]

  // Swipe game
  points       Int            @default(0)
  swipeStats   SwipeStats?
  pointHistory PointHistory[]
  payments     Payment[]

  // Peer review system (互评)
  peerReviewsGiven    PeerReview[] @relation("ReviewsGiven")
  peerReviewsReceived PeerReview[] @relation("ReviewsReceived")
  avgRating           Float? // 平均评分 (缓存)
  reviewCount         Int          @default(0) // 评价数

  // Assessment (测评)
  assessmentResults AssessmentResult[]

  // Vault (密码保险库)
  vaultItems VaultItem[]

  // Recommendations (选校推荐)
  schoolRecommendations SchoolRecommendation[]

  // Case views (案例查看记录)
  caseViews CaseView[]

  // Application timeline
  applicationTimelines ApplicationTimeline[]
  personalEvents       PersonalEvent[]

  // Verification
  verificationRequests VerificationRequest[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([email])
  @@index([deletedAt])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ============================================
// Profile & Related
// ============================================

model Profile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Public profile
  nickname  String? // 显示昵称
  avatarUrl String? // 头像 URL
  bio       String? @db.Text // 个人简介

  // Strong Sensitive - Never public
  realName String?

  // Onboarding fields
  birthday            DateTime?
  graduationDate      DateTime?
  onboardingCompleted Boolean   @default(false)

  // Sensitive - Optional anonymized
  gpa               Decimal? @db.Decimal(3, 2)
  gpaScale          Decimal  @default(4.0) @db.Decimal(3, 2)
  currentSchool     String?
  currentSchoolType String? // PUBLIC_US / PRIVATE_US / INTERNATIONAL / etc.
  grade             String? // FRESHMAN / SOPHOMORE / JUNIOR / SENIOR / GAP_YEAR

  // Non-sensitive
  targetMajor      String?
  regionPref       String[]
  budgetTier       BudgetTier?
  applicationRound String? // ED / EA / RD

  // Visibility
  visibility Visibility @default(PRIVATE)

  // Relations
  testScores  TestScore[]
  activities  Activity[]
  awards      Award[]
  education   Education[]
  essays      Essay[]
  predictions PredictionResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([visibility])
  @@index([onboardingCompleted])
}

model TestScore {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  type      TestType
  score     Int
  subScores Json? // { reading: 800, math: 800 } or { listening: 30, reading: 29 }
  testDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
}

model Activity {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name         String
  category     ActivityCategory
  role         String
  organization String?
  description  String?          @db.Text
  startDate    DateTime?
  endDate      DateTime?
  hoursPerWeek Int?
  weeksPerYear Int?
  isOngoing    Boolean          @default(false)
  order        Int              @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
}

model Award {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name        String
  level       AwardLevel
  year        Int?
  description String?
  order       Int        @default(0)

  competitionId String?
  competition   Competition? @relation(fields: [competitionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([competitionId])
}

// ============================================
// Competition Reference Data
// ============================================

model Competition {
  id            String              @id @default(cuid())
  name          String // Full English name
  abbreviation  String              @unique // e.g., "AMC 10", "USABO"
  nameZh        String? // Chinese name
  category      CompetitionCategory
  level         AwardLevel // SCHOOL / REGIONAL / STATE / NATIONAL / INTERNATIONAL
  tier          Int // 1-5 prestige (5 = highest, e.g. IMO Gold)
  description   String?             @db.Text
  descriptionZh String?             @db.Text
  website       String?
  isActive      Boolean             @default(true)

  awards    Award[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([tier])
}

model Education {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  schoolName  String
  schoolType  String? // HIGH_SCHOOL / COLLEGE / etc.
  degree      String?
  major       String?
  startDate   DateTime?
  endDate     DateTime?
  gpa         Decimal?  @db.Decimal(3, 2)
  gpaScale    Decimal?  @db.Decimal(3, 2)
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
}

model Essay {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  title     String
  prompt    String? @db.Text
  content   String  @db.Text
  wordCount Int?
  schoolId  String? // Optional: linked to specific school

  // AI results
  aiResults EssayAIResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
}

// ============================================
// School Data
// ============================================

model School {
  id      String  @id @default(cuid())
  name    String
  nameZh  String?
  country String  @default("US")
  state   String?
  city    String?

  // Rankings & Metrics
  usNewsRank      Int?
  qsRank          Int?
  acceptanceRate  Decimal? @db.Decimal(5, 2)
  tuition         Int? // Annual tuition in USD
  avgSalary       Int? // Average salary after graduation
  totalEnrollment Int?

  // Test Score Statistics (from College Scorecard)
  satAvg         Int? // SAT total average
  sat25          Int? // SAT 25th percentile (math + reading combined)
  sat75          Int? // SAT 75th percentile (math + reading combined)
  satMath25      Int? // SAT Math 25th percentile
  satMath75      Int? // SAT Math 75th percentile
  satReading25   Int? // SAT ERW 25th percentile
  satReading75   Int? // SAT ERW 75th percentile
  actAvg         Int? // ACT composite average/midpoint
  act25          Int? // ACT composite 25th percentile
  act75          Int? // ACT composite 75th percentile
  studentCount   Int? // Total student enrollment (from College Scorecard)
  graduationRate Decimal? @db.Decimal(5, 2) // 4-year graduation rate %

  // School Type
  isPrivate Boolean @default(false)

  // Niche Grades (A+, A, A-, B+, B, B-, C+, C, C-, D+, D, D-, F)
  nicheSafetyGrade  String? // Safety/Crime index
  nicheLifeGrade    String? // Student Life/Happiness index
  nicheFoodGrade    String? // Campus Food index
  nicheOverallGrade String? // Overall Niche grade

  // Search aliases (abbreviations, short names, nicknames)
  aliases String[] @default([]) // e.g. ["MIT", "麻省理工", "Mass Tech"]

  // Additional Info
  website       String?
  logoUrl       String?
  description   String? @db.Text
  descriptionZh String? @db.Text
  metadata      Json? // { deadlines, essayPrompts, requirements, lastScraped }

  // Relations
  metrics       SchoolMetric[]
  cases         AdmissionCase[]
  targetedBy    ProfileTargetSchool[]
  schoolLists   SchoolListItem[]
  essayExamples EssayExample[]
  essayPrompts  EssayPrompt[]
  essaySources  SchoolEssaySource[]
  deadlines     SchoolDeadline[]
  timelines     ApplicationTimeline[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([nameZh])
  @@index([usNewsRank])
  @@index([isPrivate])
}

model SchoolMetric {
  id       String @id @default(cuid())
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  year      Int
  metricKey String // acceptance_rate, avg_sat, avg_gpa, etc.
  value     Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@unique([schoolId, year, metricKey])
  @@index([schoolId])
}

model ProfileTargetSchool {
  id        String @id @default(cuid())
  profileId String
  schoolId  String
  school    School @relation(fields: [schoolId], references: [id])

  priority Int     @default(0) // 1: Reach, 2: Match, 3: Safety
  round    String? // ED, EA, RD, etc.

  createdAt DateTime @default(now())

  @@unique([profileId, schoolId])
  @@index([profileId])
}

// ============================================
// User School Lists (选校清单)
// ============================================

enum SchoolTier {
  SAFETY // 保底校
  TARGET // 匹配校
  REACH // 冲刺校
}

model SchoolListItem {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  tier            SchoolTier @default(TARGET)
  notes           String?    @db.Text
  round           String? // ED, EA, RD, etc.
  isAIRecommended Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, schoolId])
  @@index([userId])
  @@index([tier])
}

// ============================================
// Custom Rankings
// ============================================

model CustomRanking {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String
  weights  Json // { usNewsRank: 30, acceptanceRate: 20, tuition: 25, avgSalary: 25 }
  isPublic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isPublic])
}

// ============================================
// Predictions
// ============================================

model PredictionResult {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  schoolId       String
  probability    Decimal @db.Decimal(5, 4) // 0.0000 - 1.0000
  probabilityLow Decimal? @db.Decimal(5, 4) // 置信区间下界
  probabilityHigh Decimal? @db.Decimal(5, 4) // 置信区间上界
  factors        Json // [{ name: "GPA", impact: "positive", detail: "..." }]
  modelVersion   String  @default("v2")
  tier           String? // reach / match / safety
  confidence     String? // low / medium / high

  // 多引擎分数明细 (用于透明性和调试)
  engineScores   Json?   // { stats: 0.35, ai: 0.28, historical: 0.32, weights: {...} }
  suggestions    Json?   // 改进建议列表
  comparison     Json?   // 对比数据

  // 准确率追踪
  actualResult   String? // ADMITTED / REJECTED / WAITLISTED / UNKNOWN
  reportedAt     DateTime? // 用户报告实际结果的时间

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([profileId, schoolId]) // 每个 profile+school 只保存最新预测
  @@index([profileId])
  @@index([schoolId])
  @@index([modelVersion])
  @@index([actualResult])
}

// ============================================
// Admission Cases
// ============================================

model AdmissionCase {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  year   Int // Application year
  round  String? // ED, EA, RD
  result AdmissionResult
  major  String?

  // Anonymized profile snapshot at time of application
  gpaRange   String? // "3.7-3.9"
  satRange   String? // "1500-1550"
  actRange   String?
  toeflRange String?
  tags       String[] // ["strong_research", "legacy", "athlete"]

  // Essay content (for essay gallery)
  essayType    EssayType? // COMMON_APP, UC, SUPPLEMENTAL, WHY_SCHOOL, OTHER
  essayPrompt  String?    @db.Text // Essay prompt/question
  essayContent String?    @db.Text // Essay content
  promptNumber Int? // Common App: 1-7, UC PIQ: 1-4

  // Visibility
  visibility Visibility @default(PRIVATE)

  // Verification
  isVerified            Boolean               @default(false)
  verifiedAt            DateTime?
  verificationRequests  VerificationRequest[]

  // Swipe game
  swipes CaseSwipe[]

  // Case views
  views CaseView[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([schoolId])
  @@index([visibility])
  @@index([year])
  @@index([essayType])
}

// ============================================
// Verification System (认证系统)
// ============================================

model VerificationRequest {
  id         String             @id @default(cuid())
  userId     String
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  caseId     String
  case       AdmissionCase      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  proofType  String             // offer_letter, enrollment_proof, student_id
  proofData  String?            @db.Text // Base64 data
  proofUrl   String?            // Cloud storage URL
  status     VerificationStatus @default(PENDING)
  reviewerId String?
  reviewNote String?
  reviewedAt DateTime?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  @@index([userId])
  @@index([caseId])
  @@index([status])
}

// ============================================
// Social Features
// ============================================

model Follow {
  id          String @id @default(cuid())
  followerId  String
  followingId String
  follower    User   @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User   @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Block {
  id        String @id @default(cuid())
  blockerId String
  blockedId String
  blocker   User   @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User   @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

// ============================================
// Chat / Messaging
// ============================================

model Conversation {
  id           String                    @id @default(cuid())
  participants ConversationParticipant[]
  messages     Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([updatedAt])
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  lastReadAt DateTime?
  isPinned   Boolean   @default(false)

  createdAt DateTime @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  content    String  @db.Text
  isDeleted  Boolean @default(false)
  isRecalled Boolean @default(false)
  recalledAt DateTime?
  mediaUrl   String?
  mediaType  String?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ============================================
// Feature Hall
// ============================================

model Review {
  id            String @id @default(cuid())
  reviewerId    String
  reviewer      User   @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  profileUserId String
  profileUser   User   @relation("ReviewedProfile", fields: [profileUserId], references: [id], onDelete: Cascade)

  // 评分维度 (1-10)
  academicScore Int // 学术/GPA
  testScore     Int @default(5) // 标化成绩 (原 essayScore，语义修正)
  activityScore Int // 课外活动
  awardScore    Int @default(5) // 奖项荣誉 (新增独立维度)
  overallScore  Int // 综合评分

  // 按模块评语
  comment         String? @db.Text // 总评
  academicComment String? @db.Text // 学术评语
  testComment     String? @db.Text // 标化评语
  activityComment String? @db.Text // 活动评语
  awardComment    String? @db.Text // 奖项评语

  // 元数据
  status       ReviewStatus @default(PUBLISHED)
  tags         String[] // 评审标签: well-rounded, strong-stem 等
  helpfulCount Int          @default(0) // 缓存: 被标记有帮助的次数

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reactions ReviewReaction[]

  @@unique([reviewerId, profileUserId])
  @@index([profileUserId, status, createdAt])
  @@index([reviewerId])
}

// 评审互动反应
model ReviewReaction {
  id       String @id @default(cuid())
  reviewId String
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  type     String // "helpful" | "insightful"

  createdAt DateTime @default(now())

  @@unique([reviewId, userId, type])
  @@index([reviewId])
}

enum ReviewStatus {
  DRAFT
  PUBLISHED
  HIDDEN
}

model UserList {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String? @db.Text
  category    String? // school_ranking, major_ranking, etc.
  items       Json // Array of list items
  isPublic    Boolean @default(true)

  votes UserListVote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isPublic])
}

model UserListVote {
  id     String   @id @default(cuid())
  listId String
  list   UserList @relation(fields: [listId], references: [id], onDelete: Cascade)
  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  value Int // 1 for upvote, -1 for downvote

  createdAt DateTime @default(now())

  @@unique([listId, userId])
  @@index([listId])
}

// ============================================
// Reports & Moderation
// ============================================

model Report {
  id         String @id @default(cuid())
  reporterId String
  reporter   User   @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  targetType ReportTargetType
  targetId   String
  reason     String
  detail     String?          @db.Text
  context    Json? // Auto-attached context (e.g., chat messages)
  status     ReportStatus     @default(PENDING)

  reviewedAt DateTime?
  reviewedBy String?
  resolution String?

  createdAt DateTime @default(now())

  @@index([reporterId])
  @@index([status])
  @@index([targetType, targetId])
}

// ============================================
// Audit Logs
// ============================================

model AuditLog {
  id         String  @id @default(cuid())
  userId     String?
  action     String // VIEW_VERIFIED_CONTENT, DOWNLOAD_FILE, EXPORT_DATA, etc.
  resource   String // profile, case, file
  resourceId String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// AI Agent Memory System
// ============================================

enum MemoryType {
  FACT // 事实信息
  PREFERENCE // 用户偏好
  DECISION // 决策记录
  SUMMARY // 对话摘要
  FEEDBACK // 用户反馈
}

enum EntityType {
  SCHOOL // 学校
  PERSON // 人物
  EVENT // 事件
  TOPIC // 话题
}

// AI Agent 对话记录
model AgentConversation {
  id        String  @id @default(cuid())
  userId    String
  title     String?
  summary   String? @db.Text
  agentType String? // orchestrator, essay, school, profile, timeline
  metadata  Json?

  messages AgentMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

// AI Agent 消息
model AgentMessage {
  id             String            @id @default(cuid())
  conversationId String
  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role       String // user, assistant, tool, system
  content    String  @db.Text
  agentType  String? // 处理该消息的 Agent 类型
  toolCalls  Json? // 工具调用记录
  tokensUsed Int? // Token 使用量
  latencyMs  Int? // 响应延迟

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// 用户记忆 - 支持向量搜索
model Memory {
  id             String                       @id @default(cuid())
  userId         String
  type           MemoryType
  category       String? // school, essay, profile, timeline
  content        String                       @db.Text
  importance     Float                        @default(0.5)
  accessCount    Int                          @default(0)
  lastAccessedAt DateTime?
  embedding      Unsupported("vector(1536)")? // pgvector 向量字段
  metadata       Json?
  expiresAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([importance])
}

// 实体提取 - 学校、人物、事件、话题
model Entity {
  id          String     @id @default(cuid())
  userId      String
  type        EntityType
  name        String
  description String?    @db.Text
  attributes  Json? // 额外属性
  relations   Json? // 关系列表

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type, name])
  @@index([userId])
  @@index([type])
}

// 用户 AI 偏好设置
model UserAIPreference {
  id                 String  @id @default(cuid())
  userId             String  @unique
  communicationStyle String  @default("friendly") // friendly, professional, casual
  responseLength     String  @default("moderate") // brief, moderate, detailed
  language           String  @default("zh")
  schoolPreferences  Json? // { regions: [], size: [], type: [] }
  essayPreferences   Json? // { style: "", tone: "" }
  enableMemory       Boolean @default(true)
  enableSuggestions  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// AI Agent 企业级扩展
// ============================================

// Token 使用记录
model AgentTokenUsage {
  id               String   @id @default(cuid())
  userId           String
  conversationId   String?
  agentType        String?
  model            String
  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  cost             Decimal  @db.Decimal(10, 6)
  toolName         String?
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([agentType])
  @@index([createdAt])
}

// 用户配额
model AgentQuota {
  id            String   @id @default(cuid())
  userId        String   @unique
  tier          String   @default("FREE") // FREE, PRO, ENTERPRISE
  dailyTokens   Int      @default(100000)
  monthlyTokens Int      @default(2000000)
  dailyCost     Decimal  @default(5.00) @db.Decimal(10, 2)
  monthlyCost   Decimal  @default(100.00) @db.Decimal(10, 2)
  customLimits  Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tier])
}

// 审计日志
model AgentAuditLog {
  id         String   @id @default(cuid())
  userId     String?
  sessionId  String?
  traceId    String?
  action     String
  resource   String
  resourceId String?
  operation  String
  status     String   @default("SUCCESS")
  details    Json?
  ipAddress  String?
  userAgent  String?
  duration   Int?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([traceId])
  @@index([action])
  @@index([createdAt])
  @@index([status])
}

// 安全事件
model AgentSecurityEvent {
  id               String    @id @default(cuid())
  userId           String?
  sessionId        String?
  eventType        String
  severity         String    @default("MEDIUM")
  description      String
  payload          Json?
  mitigationAction String?
  resolved         Boolean   @default(false)
  resolvedAt       DateTime?
  resolvedBy       String?
  createdAt        DateTime  @default(now())

  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
}

// 配置版本
model AgentConfigVersion {
  id         String   @id @default(cuid())
  configType String
  configKey  String
  version    Int
  value      Json
  isActive   Boolean  @default(false)
  createdBy  String?
  comment    String?
  createdAt  DateTime @default(now())

  @@unique([configType, configKey, version])
  @@index([isActive])
}

// 记忆压缩记录
model MemoryCompaction {
  id                String   @id @default(cuid())
  userId            String
  sourceMemoryIds   String[]
  compactedMemoryId String
  compressionType   String
  originalTokens    Int
  compactedTokens   Int
  compressionRatio  Decimal  @db.Decimal(5, 2)
  metadata          Json?
  createdAt         DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// 异步任务
model AgentTask {
  id          String    @id @default(cuid())
  userId      String?
  type        String
  status      String    @default("PENDING")
  priority    Int       @default(0)
  payload     Json
  result      Json?
  error       String?
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([type])
  @@index([scheduledAt])
  @@index([priority, status])
}

// ============================================
// Forum System
// ============================================

enum TeamStatus {
  RECRUITING
  FULL
  CLOSED
}

enum TeamAppStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum ForumPostTag {
  COMPETITION // 竞赛
  ACTIVITY // 活动
  QUESTION // 提问
  SHARING // 分享
  OTHER // 其他
}

model ForumCategory {
  id            String  @id @default(cuid())
  name          String  @unique
  nameZh        String  @unique
  description   String?
  descriptionZh String?
  icon          String?
  color         String?
  sortOrder     Int     @default(0)
  isActive      Boolean @default(true)

  posts ForumPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([sortOrder])
}

model ForumPost {
  id         String        @id @default(cuid())
  categoryId String
  category   ForumCategory @relation(fields: [categoryId], references: [id])
  authorId   String
  author     User          @relation(fields: [authorId], references: [id], onDelete: Cascade)

  title   String
  content String        @db.Text
  tags    String[]
  postTag ForumPostTag? // 帖子标签：竞赛/活动/提问

  // Team post fields
  isTeamPost   Boolean    @default(false)
  teamSize     Int?
  currentSize  Int?       @default(1)
  requirements String?    @db.Text
  teamDeadline DateTime?
  teamStatus   TeamStatus @default(RECRUITING)

  // Stats
  viewCount    Int @default(0)
  likeCount    Int @default(0)
  commentCount Int @default(0)

  // Moderation
  isPinned Boolean @default(false)
  isLocked Boolean @default(false)

  // Relations
  comments         ForumComment[]
  likes            ForumLike[]
  teamMembers      TeamMember[]
  teamApplications TeamApplication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([authorId])
  @@index([isTeamPost])
  @@index([postTag])
  @@index([createdAt])
  @@index([likeCount])
}

model ForumComment {
  id       String         @id @default(cuid())
  postId   String
  post     ForumPost      @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId String
  author   User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parentId String?
  parent   ForumComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  ForumComment[] @relation("CommentReplies")

  content   String @db.Text
  likeCount Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model ForumLike {
  id     String    @id @default(cuid())
  postId String
  post   ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model TeamMember {
  id     String    @id @default(cuid())
  postId String
  post   ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String
  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  role String @default("member") // owner, member

  joinedAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model TeamApplication {
  id          String    @id @default(cuid())
  postId      String
  post        ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  applicantId String

  message    String?       @db.Text
  status     TeamAppStatus @default(PENDING)
  reviewedAt DateTime?
  reviewNote String?

  createdAt DateTime @default(now())

  @@unique([postId, applicantId])
  @@index([postId])
  @@index([applicantId])
  @@index([status])
}

// ============================================
// Essay Gallery (文书案例)
// ============================================

enum EssayType {
  COMMON_APP
  UC
  MAIN
  SUPPLEMENTAL
  SUPPLEMENT
  WHY_SCHOOL
  WHY_US
  SHORT_ANSWER
  ACTIVITY
  OPTIONAL
  OTHER
}

model EssayExample {
  id       String  @id @default(cuid())
  authorId String? // Optional: can be anonymous
  schoolId String? // Target school
  school   School? @relation(fields: [schoolId], references: [id])

  type      EssayType
  prompt    String    @db.Text
  content   String    @db.Text
  wordCount Int
  year      Int? // Application year

  // For Common App: prompt number (1-7)
  promptNumber Int?

  // Stats
  viewCount   Int      @default(0)
  likeCount   Int      @default(0)
  rating      Decimal? @db.Decimal(2, 1) // Average rating 1.0-5.0
  ratingCount Int      @default(0)

  // Verification
  isVerified Boolean @default(false)
  isPublic   Boolean @default(true)

  tags String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([type])
  @@index([isPublic])
  @@index([year])
}

// ============================================
// Swipe Game System (模拟招生官)
// ============================================

model CaseSwipe {
  id     String        @id @default(cuid())
  userId String
  caseId String
  case   AdmissionCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  prediction   String // admit, reject, waitlist
  actualResult String
  isCorrect    Boolean

  createdAt DateTime @default(now())

  @@unique([userId, caseId])
  @@index([userId])
  @@index([caseId])
}

model SwipeStats {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalSwipes         Int       @default(0)
  correctCount        Int       @default(0)
  streak              Int       @default(0)
  bestStreak          Int       @default(0)
  badge               String    @default("bronze")
  dailyChallengeCount Int       @default(0)
  dailyChallengeDate  DateTime?

  updatedAt DateTime @updatedAt

  @@index([badge])
  @@index([correctCount])
}

model PointHistory {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  action   String // SWIPE_CORRECT, REVIEW_COMPLETE, DAILY_BONUS, etc.
  points   Int
  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// Payment Records (支付记录)
// ============================================

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Payment {
  id             String        @id @default(cuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 支付信息
  transactionId  String        @unique
  plan           String // FREE, PRO, PREMIUM
  period         String // monthly, yearly
  amount         Decimal       @db.Decimal(12, 2)
  currency       String        @default("CNY")
  status         PaymentStatus @default(PENDING)
  paymentMethod  String? // stripe, alipay, wechat_pay
  idempotencyKey String?       @unique // 防重复扣费

  // 描述与元数据
  description   String?
  metadata      Json? // webhook payload 等审计信息
  failureReason String?

  // 时间
  createdAt   DateTime  @default(now())
  processedAt DateTime?
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// Peer Review System (互评系统)
// ============================================

enum PeerReviewStatus {
  PENDING // 等待对方评价
  COMPLETED // 双方都已评价
  EXPIRED // 已过期 (7天)
}

model PeerReview {
  id String @id @default(cuid())

  // 发起方 (评价者)
  reviewerId String
  reviewer   User   @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)

  // 被评方 (被评价者)
  revieweeId String
  reviewee   User   @relation("ReviewsReceived", fields: [revieweeId], references: [id], onDelete: Cascade)

  // 发起方对被评方的评分 (1-5分)
  profileScore  Int?    @db.SmallInt // 背景真实性
  helpfulScore  Int?    @db.SmallInt // 帮助程度
  responseScore Int?    @db.SmallInt // 回复及时性
  overallScore  Int?    @db.SmallInt // 总体评分
  comment       String? @db.Text // 评价内容

  // 被评方对发起方的评分 (反向评价)
  reverseProfileScore  Int?    @db.SmallInt
  reverseHelpfulScore  Int?    @db.SmallInt
  reverseResponseScore Int?    @db.SmallInt
  reverseOverallScore  Int?    @db.SmallInt
  reverseComment       String? @db.Text

  // 评价设置
  isAnonymous Boolean @default(false)

  // 状态
  status      PeerReviewStatus @default(PENDING)
  expiresAt   DateTime // 过期时间 (7天后)
  completedAt DateTime? // 完成时间

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([reviewerId, revieweeId])
  @@index([reviewerId])
  @@index([revieweeId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================
// School Deadlines (结构化截止日期)
// ============================================

model SchoolDeadline {
  id       String @id @default(cuid())
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  year                 Int // 申请季年份，如 2026 表示 Fall 2026 入学
  round                String // ED, ED2, EA, REA, RD, Rolling
  applicationDeadline  DateTime // 申请截止日期
  financialAidDeadline DateTime? // 助学金截止日期
  decisionDate         DateTime? // 放榜日期

  // 补充文书（结构化）
  essayPrompts Json? // [{prompt: string, wordLimit: number, required: boolean}]
  essayCount   Int? // 文书数量

  // 额外信息
  interviewRequired Boolean   @default(false)
  interviewDeadline DateTime?
  applicationFee    Int? // 申请费（美元）
  notes             String?   @db.Text

  // 数据来源
  source String @default("MANUAL") // MANUAL, SCRAPED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, year, round])
  @@index([schoolId])
  @@index([year])
  @@index([applicationDeadline])
}

// ============================================
// Global Events (考试/竞赛/助学金)
// ============================================

model GlobalEvent {
  id       String              @id @default(cuid())
  title    String
  titleZh  String?
  category GlobalEventCategory

  eventDate            DateTime // 事件日期（考试日、竞赛日）
  registrationDeadline DateTime? // 报名截止
  lateDeadline         DateTime? // 晚报名截止
  resultDate           DateTime? // 出分日期

  description   String? @db.Text
  descriptionZh String? @db.Text
  url           String? // 官方链接

  year        Int // 年份
  isRecurring Boolean @default(true)
  isActive    Boolean @default(true)

  // Relations
  subscribers PersonalEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([eventDate])
  @@index([year, isActive])
}

// ============================================
// Application Timeline (个性化申请时间线)
// ============================================

model ApplicationTimeline {
  id         String            @id @default(cuid())
  userId     String
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId   String
  school     School            @relation(fields: [schoolId], references: [id])
  schoolName String // 冗余字段，便于查询展示
  round      String // ED, EA, RD, ED2, REA, Rolling
  deadline   DateTime?
  status     ApplicationStatus @default(NOT_STARTED)
  progress   Int               @default(0) // 0-100
  priority   Int               @default(0)
  notes      String?           @db.Text

  tasks ApplicationTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, schoolId, round])
  @@index([userId])
  @@index([deadline])
}

model ApplicationTask {
  id         String              @id @default(cuid())
  timelineId String
  timeline   ApplicationTimeline @relation(fields: [timelineId], references: [id], onDelete: Cascade)

  title       String
  type        TaskType
  description String?   @db.Text
  dueDate     DateTime?
  completed   Boolean   @default(false)
  completedAt DateTime?
  essayId     String? // 关联到 Essay
  essayPrompt String?   @db.Text
  wordLimit   Int?
  sortOrder   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([timelineId])
  @@index([dueDate])
}

// ============================================
// Personal Events (竞赛/考试/夏校/活动/材料)
// ============================================

model PersonalEvent {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  globalEventId String? // 从 GlobalEvent 订阅时关联
  globalEvent   GlobalEvent? @relation(fields: [globalEventId], references: [id])

  title       String
  category    PersonalEventCategory
  deadline    DateTime? // 主截止日期（如报名截止）
  eventDate   DateTime? // 事件日期（如考试日、竞赛日）
  status      PersonalEventStatus   @default(NOT_STARTED)
  progress    Int                   @default(0) // 0-100
  priority    Int                   @default(0)
  description String?               @db.Text
  url         String?
  notes       String?               @db.Text

  tasks PersonalTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, globalEventId]) // 防止重复订阅同一事件
  @@index([userId])
  @@index([deadline])
  @@index([category])
}

model PersonalTask {
  id      String        @id @default(cuid())
  eventId String
  event   PersonalEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  title       String
  dueDate     DateTime?
  completed   Boolean   @default(false)
  completedAt DateTime?
  sortOrder   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([dueDate])
}

// ============================================
// Essay Prompt (文书题目)
// ============================================

enum EssayStatus {
  PENDING
  VERIFIED
  REJECTED
}

model EssayPrompt {
  id       String @id @default(cuid())
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  type      EssayType    @default(SUPPLEMENTAL)
  status    EssayStatus  @default(PENDING)
  year      Int          @default(2025)

  prompt    String       @db.Text
  promptZh  String?      @db.Text
  wordLimit Int?
  isRequired Boolean     @default(true)
  sortOrder  Int         @default(0)

  // AI 辅助字段
  aiTips     String?     @db.Text
  aiCategory String?

  // 审核字段
  verifiedBy   String?
  verifiedAt   DateTime?
  rejectReason String?   @db.Text

  // 年度变化追踪
  previousYearPromptId String?  // 关联去年同一题目
  changeType           String?  // NEW, UNCHANGED, MODIFIED

  // 来源
  sources    EssayPromptSource[]
  auditLogs  EssayPromptAudit[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([status])
  @@index([type])
  @@index([year])
  @@index([changeType])
}

model EssayPromptSource {
  id            String      @id @default(cuid())
  essayPromptId String
  essayPrompt   EssayPrompt @relation(fields: [essayPromptId], references: [id], onDelete: Cascade)

  sourceType  String
  sourceUrl   String?
  rawContent  String?   @db.Text  // 原始 HTML 片段用于审计
  confidence  Float?              // AI 置信度 0.0-1.0
  scrapedAt   DateTime?

  createdAt DateTime @default(now())

  @@index([essayPromptId])
}

// ============================================
// Essay Pipeline (文书采集管道)
// ============================================

model SchoolEssaySource {
  id       String @id @default(cuid())
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  sourceType    String   // OFFICIAL, COLLEGEVINE, COMMON_APP
  url           String
  slug          String?  // CollegeVine-style slug
  scrapeGroup   String   @default("GENERIC") // COMMON_APP, UC, COALITION, GENERIC
  isActive      Boolean  @default(true)
  priority      Int      @default(0)
  lastScrapedAt DateTime?
  lastStatus    String?  // SUCCESS, FAILED, PARTIAL
  lastError     String?

  // 针对性采集配置（单校覆盖）
  scrapeConfig Json? // { cssSelectors, removeSelectors, llmHint, maxContentLength }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, sourceType])
  @@index([schoolId])
  @@index([isActive])
  @@index([scrapeGroup])
}

model EssayPipelineRun {
  id             String   @id @default(cuid())
  trigger        String   // SCHEDULED, MANUAL
  year           Int
  status         String   @default("RUNNING") // RUNNING, COMPLETED, FAILED
  totalSchools   Int      @default(0)
  successCount   Int      @default(0)
  failedCount    Int      @default(0)
  newPrompts     Int      @default(0)
  changedPrompts Int      @default(0)
  details        Json?    // Per-school results array
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  operatorId     String?

  createdAt DateTime @default(now())

  @@index([status])
  @@index([year])
  @@index([startedAt])
}

// ============================================
// Assessment (测评系统)
// ============================================

enum AssessmentType {
  MBTI
  HOLLAND
  STRENGTH
}

model Assessment {
  id        String         @id @default(cuid())
  type      AssessmentType @unique
  title     String
  titleZh   String?
  questions Json

  results AssessmentResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssessmentResult {
  id                   String     @id @default(cuid())
  userId               String
  user                 User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessmentId         String
  assessment           Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  answers              Json
  result               Json
  majorRecommendations Json?

  completedAt DateTime @default(now())

  @@index([userId])
  @@index([assessmentId])
}

model EssayPromptAudit {
  id            String      @id @default(cuid())
  essayPromptId String
  essayPrompt   EssayPrompt @relation(fields: [essayPromptId], references: [id], onDelete: Cascade)

  action       String       // CREATE, UPDATE, VERIFY, REJECT, ARCHIVE
  fromStatus   EssayStatus?
  toStatus     EssayStatus?
  operatorId   String
  operatorType String       // ADMIN, SYSTEM, USER
  changes      Json?
  reason       String?

  createdAt DateTime @default(now())

  @@index([essayPromptId])
  @@index([operatorId])
}

// ============================================
// Vault (密码保险库)
// ============================================

model VaultItem {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          VaultItemType @default(OTHER)
  title         String
  encryptedData String        @db.Text
  iv            String        // Initialization vector for encryption
  category      String?
  tags          String[]
  icon          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([category])
}

// ============================================
// System Settings (系统设置)
// ============================================

model SystemSetting {
  key         String  @id
  value       String  @db.Text
  description String?
  category    String  @default("general")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// School Recommendation (选校推荐)
// ============================================

model SchoolRecommendation {
  id              String @id @default(cuid())
  userId          String
  user            User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileSnapshot Json
  preferences     Json
  recommendations Json
  analysis        Json
  summary         String? @db.Text
  tokenUsed       Int     @default(0)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// Essay AI Result (文书 AI 结果)
// ============================================

model EssayAIResult {
  id          String  @id @default(cuid())
  essayId     String
  essay       Essay   @relation(fields: [essayId], references: [id], onDelete: Cascade)
  type        String  // 'polish' | 'review'
  input       String  @db.Text
  output      String  @db.Text
  changes     Json?   // For polish type
  scores      Json?   // For review type
  suggestions Json?   // For review type
  tokenUsed   Int     @default(0)

  createdAt DateTime @default(now())

  @@index([essayId])
  @@index([type])
}

// ============================================
// Case View (案例查看记录)
// ============================================

model CaseView {
  id     String        @id @default(cuid())
  userId String
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  caseId String
  case   AdmissionCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, caseId])
  @@index([userId])
  @@index([caseId])
}
