generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

enum Role {
  USER
  VERIFIED
  ADMIN
}

enum Visibility {
  PRIVATE
  ANONYMOUS
  VERIFIED_ONLY
}

enum BudgetTier {
  LOW
  MEDIUM
  HIGH
  UNLIMITED
}

enum TestType {
  SAT
  ACT
  TOEFL
  IELTS
  AP
  IB
}

enum ActivityCategory {
  ACADEMIC
  ARTS
  ATHLETICS
  COMMUNITY_SERVICE
  LEADERSHIP
  WORK
  RESEARCH
  OTHER
}

enum AwardLevel {
  SCHOOL
  REGIONAL
  STATE
  NATIONAL
  INTERNATIONAL
}

enum ReportTargetType {
  USER
  MESSAGE
  CASE
  REVIEW
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum AdmissionResult {
  ADMITTED
  REJECTED
  WAITLISTED
  DEFERRED
}

// ============================================
// User & Auth
// ============================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  role              Role      @default(USER)
  emailVerified     Boolean   @default(false)
  emailVerifyToken  String?
  passwordResetToken String?
  passwordResetExpires DateTime?
  locale            String    @default("zh")
  
  // Points system
  points            Int       @default(0)
  
  // Relations
  profile           Profile?
  followers         Follow[]  @relation("Following")
  following         Follow[]  @relation("Followers")
  blockedUsers      Block[]   @relation("Blocker")
  blockedBy         Block[]   @relation("Blocked")
  sentMessages      Message[]
  conversations     ConversationParticipant[]
  customRankings    CustomRanking[]
  reviewsGiven      Review[]  @relation("Reviewer")
  reviewsReceived   Review[]  @relation("ReviewedProfile")
  reports           Report[]
  admissionCases    AdmissionCase[]
  userLists         UserList[]
  userListVotes     UserListVote[]
  pointHistory      PointHistory[]
  caseViews         CaseView[]
  
  // AI Memory System
  agentConversations AgentConversation[]
  memories           Memory[]
  entities           Entity[]
  aiPreferences      UserAIPreference?
  
  // Verification
  verificationRequests VerificationRequest[]
  
  // AI Recommendations
  schoolRecommendations SchoolRecommendation[]
  
  // Application Timelines
  applicationTimelines ApplicationTimeline[]
  
  // Swipe Game
  caseSwipes    CaseSwipe[]
  swipeStats    SwipeStats?
  
  // Assessments
  assessmentResults AssessmentResult[]
  
  // Forum
  forumPosts        ForumPost[]
  forumComments     ForumComment[]
  forumLikes        ForumLike[]
  teamApplications  TeamApplication[]
  teamMemberships   TeamMember[]
  
  // Vault
  vaultItems        VaultItem[]
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  @@index([email])
  @@index([deletedAt])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ============================================
// Profile & Related
// ============================================

model Profile {
  id              String     @id @default(cuid())
  userId          String     @unique
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Strong Sensitive - Never public
  realName        String?
  
  // Sensitive - Optional anonymized
  gpa             Decimal?   @db.Decimal(3, 2)
  gpaScale        Decimal    @default(4.0) @db.Decimal(3, 2)
  currentSchool   String?
  currentSchoolType String?  // PUBLIC_US / PRIVATE_US / INTERNATIONAL / etc.
  grade           String?    // FRESHMAN / SOPHOMORE / JUNIOR / SENIOR / GAP_YEAR
  
  // Non-sensitive
  targetMajor     String?
  regionPref      String[]
  budgetTier      BudgetTier?
  applicationRound String?   // ED / EA / RD
  
  // Visibility
  visibility      Visibility @default(PRIVATE)
  
  // Relations
  testScores      TestScore[]
  activities      Activity[]
  awards          Award[]
  education       Education[]
  essays          Essay[]
  predictions     PredictionResult[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([userId])
  @@index([visibility])
}

model TestScore {
  id        String    @id @default(cuid())
  profileId String
  profile   Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  type      TestType
  score     Int
  subScores Json?     // { reading: 800, math: 800 } or { listening: 30, reading: 29 }
  testDate  DateTime?
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([profileId])
}

model Activity {
  id           String           @id @default(cuid())
  profileId    String
  profile      Profile          @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  name         String
  category     ActivityCategory
  role         String
  organization String?
  description  String?          @db.Text
  startDate    DateTime?
  endDate      DateTime?
  hoursPerWeek Int?
  weeksPerYear Int?
  isOngoing    Boolean          @default(false)
  order        Int              @default(0)
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([profileId])
}

model Award {
  id          String     @id @default(cuid())
  profileId   String
  profile     Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  name        String
  level       AwardLevel
  year        Int?
  description String?
  order       Int        @default(0)
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([profileId])
}

model Education {
  id           String   @id @default(cuid())
  profileId    String
  profile      Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  schoolName   String
  schoolType   String?  // HIGH_SCHOOL / COLLEGE / etc.
  degree       String?
  major        String?
  startDate    DateTime?
  endDate      DateTime?
  gpa          Decimal? @db.Decimal(3, 2)
  gpaScale     Decimal? @db.Decimal(3, 2)
  description  String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([profileId])
}

model Essay {
  id        String   @id @default(cuid())
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  title     String
  prompt    String?  @db.Text
  content   String   @db.Text
  wordCount Int?
  schoolId  String?  // Optional: linked to specific school
  
  // AI Results
  aiResults EssayAIResult[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
}

// AI 文书处理结果
model EssayAIResult {
  id          String   @id @default(cuid())
  essayId     String
  essay       Essay    @relation(fields: [essayId], references: [id], onDelete: Cascade)
  
  type        String   // "polish" | "review" | "brainstorm" | "rewrite"
  input       String   @db.Text
  output      String   @db.Text
  
  // Review specific fields
  scores      Json?    // { clarity: 8, uniqueness: 7, storytelling: 8, fit: 7, language: 8 }
  suggestions Json?    // ["建议1", "建议2"]
  
  // Polish specific fields
  changes     Json?    // [{ original, revised, reason }]
  
  tokenUsed   Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  @@index([essayId])
  @@index([type])
}

// AI 选校建议
model SchoolRecommendation {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 用户输入快照
  profileSnapshot Json     // 用户档案快照
  preferences     Json?    // { regions: [], majors: [], budget: "" }
  
  // AI 推荐结果
  recommendations Json     // [{ schoolId, schoolName, tier, probability, fitScore, reasons, concerns }]
  analysis        Json?    // { strengths: [], weaknesses: [], tips: [] }
  summary         String?  @db.Text
  
  tokenUsed       Int      @default(0)
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
}

// 申请时间线状态
enum ApplicationStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  ACCEPTED
  REJECTED
  WAITLISTED
  WITHDRAWN
}

// 申请时间线
model ApplicationTimeline {
  id          String            @id @default(cuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  schoolId    String
  school      School            @relation(fields: [schoolId], references: [id])
  schoolName  String            // 冗余存储，避免每次 join
  
  round       String            // ED, ED2, EA, REA, RD, Rolling
  deadline    DateTime?
  status      ApplicationStatus @default(NOT_STARTED)
  
  // 进度追踪
  progress    Int               @default(0) // 0-100
  priority    Int               @default(0) // 排序用
  notes       String?           @db.Text
  
  // 任务
  tasks       ApplicationTask[]
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@unique([userId, schoolId, round])
  @@index([userId])
  @@index([deadline])
  @@index([status])
}

// 申请任务类型
enum TaskType {
  ESSAY
  DOCUMENT
  TEST
  INTERVIEW
  RECOMMENDATION
  OTHER
}

// 申请任务
model ApplicationTask {
  id          String              @id @default(cuid())
  timelineId  String
  timeline    ApplicationTimeline @relation(fields: [timelineId], references: [id], onDelete: Cascade)
  
  title       String
  type        TaskType            @default(OTHER)
  description String?             @db.Text
  dueDate     DateTime?
  
  // 状态
  completed   Boolean             @default(false)
  completedAt DateTime?
  
  // 文书关联
  essayId     String?
  essayPrompt String?             @db.Text
  wordLimit   Int?
  
  // 排序
  sortOrder   Int                 @default(0)
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  @@index([timelineId])
  @@index([dueDate])
}

// ============================================
// Tinder式案例滑动
// ============================================

// 用户滑动预测记录
model CaseSwipe {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  caseId      String
  case        AdmissionCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  prediction  String        // "admit" | "reject" | "waitlist"
  actualResult String       // 真实结果
  isCorrect   Boolean       // 预测是否正确
  
  swipedAt    DateTime      @default(now())
  
  @@unique([userId, caseId])
  @@index([userId])
  @@index([isCorrect])
}

// 用户滑动统计
model SwipeStats {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  totalSwipes Int      @default(0)
  correctCount Int     @default(0)
  streak      Int      @default(0)      // 连续正确数
  bestStreak  Int      @default(0)      // 最高连续正确
  
  // 徽章等级: bronze, silver, gold, platinum, diamond
  badge       String   @default("bronze")
  
  // 每日挑战
  dailyChallengeDate DateTime?
  dailyChallengeCount Int      @default(0)
  
  updatedAt   DateTime @updatedAt
}

// ============================================
// 专业测评系统
// ============================================

// 测评类型
enum AssessmentType {
  MBTI
  HOLLAND
  MAJOR_MATCH
}

// 测评题目
model Assessment {
  id          String         @id @default(cuid())
  type        AssessmentType
  title       String
  titleZh     String
  description String?        @db.Text
  descriptionZh String?      @db.Text
  
  // 题目 JSON 数组
  questions   Json           // [{ id, text, textZh, options: [{ value, text, textZh }], dimension? }]
  
  // 结果解释
  resultInterpretations Json? // { "INTJ": { title, description }, ... }
  
  isActive    Boolean        @default(true)
  sortOrder   Int            @default(0)
  
  results     AssessmentResult[]
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

// 测评结果
model AssessmentResult {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  
  // 用户答案
  answers      Json       // [{ questionId, answer }]
  
  // 计算结果
  result       Json       // MBTI: { type: "INTJ", scores: { E: 30, I: 70, ... } }
                          // Holland: { codes: "RIA", scores: { R: 80, I: 75, ... } }
  
  // 专业推荐（如果是专业匹配测试）
  majorRecommendations Json? // [{ major, score, reasons }]
  
  completedAt  DateTime   @default(now())
  
  @@index([userId])
  @@index([assessmentId])
}

// ============================================
// Forum System
// ============================================

// 论坛分类
model ForumCategory {
  id          String   @id @default(cuid())
  name        String
  nameZh      String
  description String?
  descriptionZh String?
  icon        String?  // lucide icon name
  color       String?  // 主题色
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  
  posts       ForumPost[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 论坛帖子
model ForumPost {
  id          String   @id @default(cuid())
  categoryId  String
  category    ForumCategory @relation(fields: [categoryId], references: [id])
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  title       String
  content     String   @db.Text
  tags        String[]
  
  // 组队帖子特有字段
  isTeamPost  Boolean  @default(false)
  teamSize    Int?
  currentSize Int?     @default(1)  // 当前人数
  requirements String?  @db.Text
  teamDeadline DateTime?
  teamStatus  TeamStatus @default(RECRUITING)
  
  // 统计
  viewCount   Int      @default(0)
  likeCount   Int      @default(0)
  commentCount Int     @default(0)
  
  // 状态
  isPinned    Boolean  @default(false)
  isLocked    Boolean  @default(false)
  
  // 关系
  comments    ForumComment[]
  likes       ForumLike[]
  teamApplications TeamApplication[]
  teamMembers TeamMember[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([categoryId])
  @@index([authorId])
  @@index([isTeamPost])
  @@index([createdAt])
}

enum TeamStatus {
  RECRUITING  // 招募中
  FULL        // 已满员
  CLOSED      // 已关闭
  COMPLETED   // 已完成
}

// 论坛评论
model ForumComment {
  id        String   @id @default(cuid())
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  
  // 回复嵌套
  parentId  String?
  parent    ForumComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   ForumComment[] @relation("CommentReplies")
  
  likeCount Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

// 论坛点赞
model ForumLike {
  id        String   @id @default(cuid())
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([postId, userId])
}

// 组队申请
model TeamApplication {
  id          String   @id @default(cuid())
  postId      String
  post        ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  applicantId String
  applicant   User     @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  
  message     String?  @db.Text
  status      TeamAppStatus @default(PENDING)
  
  reviewedAt  DateTime?
  reviewNote  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([postId, applicantId])
  @@index([postId])
  @@index([applicantId])
}

enum TeamAppStatus {
  PENDING   // 待审核
  ACCEPTED  // 已接受
  REJECTED  // 已拒绝
  CANCELLED // 已取消
}

// 团队成员
model TeamMember {
  id        String   @id @default(cuid())
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role      String   @default("member")  // owner, admin, member
  joinedAt  DateTime @default(now())
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

// ============================================
// Vault (保险箱)
// ============================================

model VaultItem {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        VaultItemType
  title       String
  
  // 加密存储的数据
  encryptedData String @db.Text
  iv          String   // 初始化向量
  
  // 元数据（不加密）
  category    String?
  tags        String[]
  icon        String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([type])
}

enum VaultItemType {
  CREDENTIAL  // 账号密码
  DOCUMENT    // 文档
  NOTE        // 笔记
  CERTIFICATE // 证书
}

// ============================================
// School Data
// ============================================

model School {
  id              String   @id @default(cuid())
  name            String
  nameZh          String?
  country         String   @default("US")
  state           String?
  city            String?
  
  // Rankings & Metrics
  usNewsRank      Int?
  qsRank          Int?
  acceptanceRate  Decimal? @db.Decimal(5, 2)
  tuition         Int?     // Annual tuition in USD
  avgSalary       Int?     // Average salary after graduation
  totalEnrollment Int?
  
  // College Scorecard data
  satAvg          Int?     // Average SAT score
  actAvg          Int?     // Average ACT score  
  studentCount    Int?     // Total student population
  graduationRate  Decimal? @db.Decimal(5, 2) // 4-year graduation rate
  
  // Additional Info
  website         String?
  logoUrl         String?
  description     String?  @db.Text
  descriptionZh   String?  @db.Text
  metadata        Json?    // { scorecardId: "xxx", lastSync: "2024-01-01" }
  
  // Relations
  metrics              SchoolMetric[]
  cases                AdmissionCase[]
  targetedBy           ProfileTargetSchool[]
  applicationTimelines ApplicationTimeline[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([name])
  @@index([usNewsRank])
}

model SchoolMetric {
  id        String   @id @default(cuid())
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  year      Int
  metricKey String   // acceptance_rate, avg_sat, avg_gpa, etc.
  value     Decimal  @db.Decimal(10, 2)
  
  createdAt DateTime @default(now())

  @@unique([schoolId, year, metricKey])
  @@index([schoolId])
}

model ProfileTargetSchool {
  id        String  @id @default(cuid())
  profileId String
  schoolId  String
  school    School  @relation(fields: [schoolId], references: [id])
  
  priority  Int     @default(0) // 1: Reach, 2: Match, 3: Safety
  round     String? // ED, EA, RD, etc.
  
  createdAt DateTime @default(now())

  @@unique([profileId, schoolId])
  @@index([profileId])
}

// ============================================
// Custom Rankings
// ============================================

model CustomRanking {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  weights   Json     // { usNewsRank: 30, acceptanceRate: 20, tuition: 25, avgSalary: 25 }
  isPublic  Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isPublic])
}

// ============================================
// Predictions
// ============================================

model PredictionResult {
  id         String   @id @default(cuid())
  profileId  String
  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  schoolId   String
  probability Decimal @db.Decimal(5, 4) // 0.0000 - 1.0000
  factors    Json     // [{ name: "GPA", impact: "positive", detail: "..." }]
  modelVersion String @default("v1")
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([profileId, schoolId])
  @@index([profileId])
  @@index([schoolId])
}

// ============================================
// Admission Cases
// ============================================

model AdmissionCase {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId    String
  school      School          @relation(fields: [schoolId], references: [id])
  
  year        Int             // Application year
  round       String?         // ED, EA, RD
  result      AdmissionResult
  major       String?
  
  // Anonymized profile snapshot at time of application
  gpaRange    String?         // "3.7-3.9"
  satRange    String?         // "1500-1550"
  actRange    String?
  toeflRange  String?
  tags        String[]        // ["strong_research", "legacy", "athlete"]
  
  // Visibility
  visibility  Visibility      @default(PRIVATE)
  
  // Verification
  isVerified  Boolean         @default(false)
  verifiedAt  DateTime?
  verificationRequests VerificationRequest[]
  
  // Relations
  caseViews   CaseView[]
  caseSwipes  CaseSwipe[]
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([userId])
  @@index([schoolId])
  @@index([visibility])
  @@index([year])
}

// ============================================
// Social Features
// ============================================

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

// ============================================
// Chat / Messaging
// ============================================

model Conversation {
  id           String                    @id @default(cuid())
  participants ConversationParticipant[]
  messages     Message[]
  
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt

  @@index([updatedAt])
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lastReadAt     DateTime?
  
  createdAt      DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  content        String       @db.Text
  isDeleted      Boolean      @default(false)
  
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ============================================
// Feature Hall
// ============================================

model Review {
  id             String   @id @default(cuid())
  reviewerId     String
  reviewer       User     @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  profileUserId  String
  profileUser    User     @relation("ReviewedProfile", fields: [profileUserId], references: [id], onDelete: Cascade)
  
  academicScore  Int      // 1-10
  activityScore  Int      // 1-10
  essayScore     Int      // 1-10
  overallScore   Int      // 1-10
  comment        String?  @db.Text
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([reviewerId, profileUserId])
  @@index([reviewerId])
  @@index([profileUserId])
}

model UserList {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String?        @db.Text
  category    String?        // school_ranking, major_ranking, etc.
  items       Json           // Array of list items
  isPublic    Boolean        @default(true)
  
  votes       UserListVote[]
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([userId])
  @@index([isPublic])
}

model UserListVote {
  id        String   @id @default(cuid())
  listId    String
  list      UserList @relation(fields: [listId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  value     Int      // 1 for upvote, -1 for downvote
  
  createdAt DateTime @default(now())

  @@unique([listId, userId])
  @@index([listId])
}

// ============================================
// Reports & Moderation
// ============================================

model Report {
  id         String           @id @default(cuid())
  reporterId String
  reporter   User             @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  
  targetType ReportTargetType
  targetId   String
  reason     String
  detail     String?          @db.Text
  context    Json?            // Auto-attached context (e.g., chat messages)
  status     ReportStatus     @default(PENDING)
  
  reviewedAt DateTime?
  reviewedBy String?
  resolution String?
  
  createdAt  DateTime         @default(now())

  @@index([reporterId])
  @@index([status])
  @@index([targetType, targetId])
}

// ============================================
// Audit Logs
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // VIEW_VERIFIED_CONTENT, DOWNLOAD_FILE, EXPORT_DATA, etc.
  resource  String   // profile, case, file
  resourceId String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// Points & Incentive System
// ============================================

model PointHistory {
  id        String   @id @default(cuid())
  userId    String
  action    String   // SUBMIT_CASE, CASE_VERIFIED, VIEW_CASE_DETAIL, etc.
  points    Int      // positive for earning, negative for spending
  metadata  Json?    // { caseId: "xxx", etc. }
  
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model CaseView {
  id        String   @id @default(cuid())
  userId    String
  caseId    String
  
  user      User          @relation(fields: [userId], references: [id])
  case      AdmissionCase @relation(fields: [caseId], references: [id])
  createdAt DateTime      @default(now())

  @@unique([userId, caseId])
  @@index([userId])
  @@index([caseId])
}

// ============================================
// Verification System
// ============================================

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

model VerificationRequest {
  id          String             @id @default(cuid())
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  caseId      String
  case        AdmissionCase      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  // 上传的证明文件 (Base64 或 URL)
  proofType   String             // "offer_letter" | "enrollment_proof" | "student_id"
  proofUrl    String?            // 文件URL（如果使用云存储）
  proofData   String?            // Base64数据（如果直接存储）
  
  status      VerificationStatus @default(PENDING)
  reviewerId  String?            // 审核管理员ID
  reviewNote  String?            // 审核备注
  reviewedAt  DateTime?
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([userId])
  @@index([caseId])
  @@index([status])
}

// ============================================
// AI Agent Memory System
// ============================================

enum MemoryType {
  FACT           // 用户陈述的事实
  PREFERENCE     // 用户偏好
  DECISION       // 做出的决定（如选校）
  SUMMARY        // 对话摘要
  FEEDBACK       // 用户反馈
}

enum EntityType {
  SCHOOL         // 学校
  PERSON         // 人物
  EVENT          // 事件
  TOPIC          // 话题/主题
}

// AI Agent 对话会话
model AgentConversation {
  id          String    @id @default(cuid())
  userId      String
  title       String?
  summary     String?   @db.Text
  agentType   String?   // 主要处理的 Agent
  metadata    Json?     // 额外元数据
  isArchived  Boolean   @default(false)
  
  user        User      @relation(fields: [userId], references: [id])
  messages    AgentMessage[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  archivedAt  DateTime?

  @@index([userId])
  @@index([createdAt])
  @@index([isArchived])
}

// Agent 消息记录
model AgentMessage {
  id             String            @id @default(cuid())
  conversationId String
  role           String            // user, assistant, tool, system
  content        String            @db.Text
  agentType      String?           // 处理消息的 Agent
  toolCalls      Json?             // 工具调用记录
  tokensUsed     Int?              // Token 使用量
  latencyMs      Int?              // 响应延迟
  
  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime          @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// 记忆条目
model Memory {
  id            String     @id @default(cuid())
  userId        String
  type          MemoryType
  category      String?    // school, essay, profile, timeline
  content       String     @db.Text
  importance    Float      @default(0.5) // 0-1 重要性评分
  accessCount   Int        @default(0)
  lastAccessedAt DateTime?
  expiresAt     DateTime?  // 可选过期时间
  
  // 向量嵌入 (pgvector)
  // Prisma 不原生支持 vector 类型，使用 Unsupported
  embedding     Unsupported("vector(1536)")?
  
  metadata      Json?      // 额外元数据
  
  user          User       @relation(fields: [userId], references: [id])
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([userId, type])
  @@index([userId, category])
  @@index([importance])
  @@index([createdAt])
}

// 实体记录
model Entity {
  id          String     @id @default(cuid())
  userId      String
  type        EntityType
  name        String
  description String?    @db.Text
  attributes  Json?      // 实体属性
  relations   Json?      // 关系 [{type, targetId, targetName}]
  
  // 向量嵌入 (pgvector)
  embedding   Unsupported("vector(1536)")?
  
  user        User       @relation(fields: [userId], references: [id])
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([userId, type, name])
  @@index([userId, type])
}

// 用户 AI 偏好
model UserAIPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique
  
  // 沟通偏好
  communicationStyle   String   @default("friendly") // friendly, professional, casual
  responseLength       String   @default("moderate") // brief, moderate, detailed
  language             String   @default("zh-CN")
  
  // 学校偏好
  schoolPreferences    Json?    // { regions: [], size: [], type: [] }
  
  // 文书偏好
  essayPreferences     Json?    // { style: "vivid", tone: "personal" }
  
  // 其他设置
  enableMemory         Boolean  @default(true)
  enableSuggestions    Boolean  @default(true)
  
  user                 User     @relation(fields: [userId], references: [id])
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// ============================================
// 系统设置
// ============================================

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique  // e.g. "admin_email", "site_name"
  value       String   // JSON string for complex values
  description String?  // 设置说明
  category    String   @default("general") // general, notification, security, etc.
  isPublic    Boolean  @default(false) // 是否可被前端读取
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}
